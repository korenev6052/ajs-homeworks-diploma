!function(e){var t={};function a(s){if(t[s])return t[s].exports;var i=t[s]={i:s,l:!1,exports:{}};return e[s].call(i.exports,i,i.exports,a),i.l=!0,i.exports}a.m=e,a.c=t,a.d=function(e,t,s){a.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(a.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(s,i,function(t){return e[t]}.bind(null,i));return s},a.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(t,"a",t),t},a.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},a.p="",a(a.s=1)}([function(e,t,a){},function(e,t,a){"use strict";a.r(t);a(0);function s(e,t){const a=t-1,s=t*(t-1),i=t**2-1;return 0===e?"top-left":e===a?"top-right":e===s?"bottom-left":e===i?"bottom-right":e>0&&e<a?"top":e>s&&e<i?"bottom":e%t==0?"left":(e+1)%t==0?"right":"center"}function i(e,t,a){const s=[];for(let e=0;e<a;e+=1){s[e]=[];for(let t=0;t<a;t+=1)s[e][t]=e*a+t}const i=e<a?0:Math.floor(e/a),r=e<a?e:e%a,n=[];for(let e=1;e<=t;e+=1)i-e>=0&&r-e>=0&&n.push(s[i-e][r-e]),i-e>=0&&n.push(s[i-e][r]),i-e>=0&&r+e<a&&n.push(s[i-e][r+e]),r-e>=0&&n.push(s[i][r-e]),r+e<a&&n.push(s[i][r+e]),i+e<a&&r-e>=0&&n.push(s[i+e][r-e]),i+e<a&&n.push(s[i+e][r]),i+e<a&&r+e<a&&n.push(s[i+e][r+e]);return n}function r(e){return e[Math.round(Math.random()*(e.length-1))]}class n{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",e=>this.onNewGameClick(e)),this.saveGameEl.addEventListener("click",e=>this.onSaveGameClick(e)),this.loadGameEl.addEventListener("click",e=>this.onLoadGameClick(e)),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const t=document.createElement("div");t.classList.add("cell","map-tile",`map-tile-${s(e,this.boardSize)}`),t.addEventListener("mouseenter",e=>this.onCellEnter(e)),t.addEventListener("mouseleave",e=>this.onCellLeave(e)),t.addEventListener("click",e=>this.onCellClick(e)),this.boardEl.appendChild(t)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator",`health-level-indicator-${t=a.character.health,t<15?"critical":t<50?"normal":"high"}`),r.style.width=`${a.character.health}%`,i.appendChild(r),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach(e=>e.call(null,t))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach(e=>e.call(null,t))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach(e=>e.call(null,t))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach(e=>e.call(null))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach(e=>e.call(null))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach(e=>e.call(null))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e,t="yellow"){this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter(e=>e.startsWith("selected")))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise(a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",()=>{s.removeChild(i),a()})})}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}var h={default:"prairie",round1:"prairie",round2:"desert",round3:"arctic",round4:"mountain"};class o{constructor(){this.theme=h.default,this.round=null,this.user=null,this.engine=null,this.positionedCharacters=null,this.activePlater=null,this.statistics=null}static from(e){return"object"==typeof e?e:null}}var l={medal:String.fromCharCode(55356,57238),swords:String.fromCharCode(9876),shield:String.fromCharCode(55357,57057),heart:String.fromCharCode(10084)};class c{constructor(e,t="generic"){if(this.type=t,this.level=e,this.attack=null,this.defence=null,this.health=null,this.maxHealth=null,this.moveRadius=null,this.attackRadius=null,"Character"===new.target.name)throw new Error("User use <new Character()>")}get message(){return`${l.medal} ${this.level} `+`${l.swords} ${this.attack} `+`${l.shield} ${this.defence} `+`${l.heart} ${this.health}`}levelUp(){this.level+=1,this.attack=Math.round(Math.max(this.attack,this.attack*(1.8-this.health/100))),this.health<0&&(this.health=0),this.maxHealth=this.health<20?this.health+80:100}restoreHealth(){this.health=this.maxHealth}isLiving(){return this.health>0}}class d extends c{constructor(e){super(e,"bowman"),this.attack=25,this.defence=25,this.health=100,this.maxHealth=100,this.moveRadius=2,this.attackRadius=2}}class u extends c{constructor(e){super(e,"daemon"),this.attack=10,this.defence=40,this.health=100,this.maxHealth=100,this.moveRadius=1,this.attackRadius=4}}class m extends c{constructor(e){super(e,"magician"),this.attack=10,this.defence=40,this.health=100,this.maxHealth=100,this.moveRadius=1,this.attackRadius=4}}class g extends c{constructor(e){super(e,"swordsman"),this.attack=40,this.defence=10,this.health=100,this.maxHealth=100,this.moveRadius=4,this.attackRadius=1}}class p extends c{constructor(e){super(e,"undead"),this.attack=25,this.defence=25,this.health=100,this.maxHealth=100,this.moveRadius=4,this.attackRadius=1}}class C extends c{constructor(e){super(e,"vampire"),this.attack=40,this.defence=10,this.health=100,this.maxHealth=100,this.moveRadius=2,this.attackRadius=2}}class v{constructor(e,t){if(this.player=e,this.allowedTypes=t,this._characters=new Set,this.points=0,"Team"===new.target.name)throw new Error("User use <new Team()>")}set characters(e){this._characters.clear(),e.forEach(e=>{this._characters.add(e)})}get characters(){return Array.from(this._characters)}get charactersCount(){return this._characters.size}get livingCharacters(){return this.characters.filter(e=>e.isLiving())}get livingCharactersCount(){return this.characters.reduce((e,t)=>(t.isLiving()&&(e+=1),e),0)}addCharacter(e){if(!(e instanceof c))throw new Error("Character must be instance of Character or its children");this._characters.add(e)}addCharacters(e){e.forEach(e=>this.addCharacter(e))}charactersLevelUp(){this._characters.forEach(e=>{e.isLiving()&&(e.restoreHealth(),e.levelUp())})}calcPoints(){this.points=this.characters.reduce((e,t)=>(t.isLiving()&&(e+=t.health),e),this.points)}}class f extends v{constructor(){super("user",[g,d,m])}}class y extends v{constructor(){super("engine",[u,p,C])}}class S{constructor(e,t,a){if(!(e instanceof c))throw new Error("Character must be instance of Character or its children");if("number"!=typeof t)throw new Error("Position must be a number");this.character=e,this.position=t,this.player=a}}function*w(e,t){for(;;){const a=e[Math.floor(Math.random()*e.length)],s=Math.round(Math.random()*(t-1)+1);yield new a(s)}}function P(e,t,a){const s=w(e,t),i=[];for(let e=0;e<a;e+=1)i.push(s.next().value);return i}function L(e,t,a){if("left"!==t&&"right"!==t)throw new Error("Side must be <left> or <right>");const s=[],i=e**2;let r="left"===t?0:e-2;for(;r<i;r+=e)s.push(r),s.push(r+1);return function(e){let t,a;for(let s=e.length-1;s>0;s-=1)t=Math.floor(Math.random()*(s+1)),a=e[t],e[t]=e[s],e[s]=a;return e}(s).slice(0,a)}var b={code101:"Game started, good luck!",code102:"Game saved",code103:"Game loaded",code104:"Game ower! Winner:",code105:"Round ower! Winner:",code301:"Board is locked",code302:"Users player is not active",code303:"Users character is not selected",code304:"Move is impossible. Cell is too far from the character",code305:"You must select users character",code306:"Attack is impossible. Cell is too far from the character"};var k={bowman:d,daemon:u,magician:m,swordsman:g,vampire:C,undead:p};const E=new n;E.bindToDOM(document.querySelector("#game-container")),new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.gameState=new o,this.boardUnlocked=!1,this.selectedCharacter=null,this.movePositions=[],this.attackPositions=[]}init(){this.gamePlay.drawUi(this.gameState.theme),this.gamePlay.addNewGameListener(this.onNewGame.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGame.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGame.bind(this)),this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this))}onNewGame(){this.gameState.round=1,this.gameState.user=new f,this.gameState.engine=new y,this.newRoundInit(),n.showMessage(b.code101),this.boardUnlocked=!0}onSaveGame(){const e={theme:this.gameState.theme,round:this.gameState.round,user:{player:this.gameState.user.player,points:this.gameState.user.points},engine:{player:this.gameState.engine.player,points:this.gameState.engine.points},positionedCharacters:this.gameState.positionedCharacters,activePlayer:this.gameState.activePlayer,statistics:this.gameState.statistics};this.stateService.save(o.from(e)),n.showMessage(b.code102)}onLoadGame(){const e=this.stateService.load();return e?(this.gameState.user=new f,this.gameState.engine=new y,this.gameState.theme=e.theme,this.gameState.round=e.round,this.gameState.user.player=e.user.player,this.gameState.user.points=e.user.points,this.gameState.engine.player=e.engine.player,this.gameState.engine.points=e.engine.points,this.gameState.activePlayer=e.activePlayer,this.gameState.statistics=e.statistics,this.gameState.positionedCharacters=e.positionedCharacters.map(t=>{const{player:a,position:s}=t,{type:i,level:r,attack:n,defence:h,health:o,maxHealth:l}=t.character,c=new k[i](r);return c.attack=n,c.defence=h,c.health=o,c.maxHealth=l,a===e.user.player?this.gameState.user.addCharacter(c):this.gameState.engine.addCharacter(c),{character:c,position:s,player:a}}),this.gamePlay.drawUi(this.gameState.theme),this.gamePlay.redrawPositions(this.gameState.positionedCharacters),n.showMessage(b.code103),this.gameState.activePlayer===this.gameState.user.player?this.boardUnlocked=!0:this.activateEngine(),!0):(n.showMessage(b.code301),!1)}onCellEnter(e){this.boardUnlocked&&this.isUsersActivePlayer()?this.actionWithCell(e,()=>{this.gamePlay.setCursor("not-allowed")},()=>{this.canMove(e)?(this.gamePlay.selectCell(e,"green"),this.gamePlay.setCursor("pointer")):this.gamePlay.setCursor("not-allowed")},t=>{this.gamePlay.showCellTooltip(t.character.message,e),this.isInnerUsersCharacter(t)?this.gamePlay.setCursor("pointer"):this.gamePlay.setCursor("not-allowed")},t=>{this.gamePlay.showCellTooltip(t.character.message,e),this.isInnerUsersCharacter(t)?this.gamePlay.setCursor("pointer"):this.canAttack(e)?(this.gamePlay.selectCell(e,"red"),this.gamePlay.setCursor("crosshair")):this.gamePlay.setCursor("not-allowed")}):this.gamePlay.setCursor("not-allowed")}onCellLeave(e){this.boardUnlocked&&(this.gamePlay.hideCellTooltip(e),this.selectedCharacter&&e!==this.selectedCharacter.position&&this.gamePlay.deselectCell(e))}onCellClick(e){this.boardUnlocked?this.isUsersActivePlayer()?this.actionWithCell(e,()=>{n.showError(b.code303)},()=>{this.canMove(e)?(this.gamePlay.deselectCell(this.selectedCharacter.position),this.gamePlay.deselectCell(e),this.moveCharacter(e),this.activateEngine()):n.showError(b.code304)},t=>{this.isInnerUsersCharacter(t)?(this.gamePlay.selectCell(e),this.selectCharacter(e,t)):n.showError(b.code305)},t=>{if(this.isInnerUsersCharacter(t))return this.gamePlay.deselectCell(this.selectedCharacter.position),this.gamePlay.selectCell(e),void this.selectCharacter(e,t);this.canAttack(e)?(this.gamePlay.deselectCell(this.selectedCharacter.position),this.gamePlay.deselectCell(e),this.attackCharacter(e,t,()=>{this.hasRoundWinner()?this.roundUp():this.activateEngine()})):n.showError(b.code306)}):n.showMessage(b.code302):n.showMessage(b.code301)}actionWithCell(e,t,a,s,i){if(!this.isInnerCharacter(e)&&!this.selectedCharacter)return void t();if(!this.isInnerCharacter(e)&&this.selectedCharacter)return void a();const r=this.gameState.positionedCharacters.find(t=>t.position===e);this.selectedCharacter?this.selectedCharacter&&i(r):s(r)}selectCharacter(e,t){this.selectedCharacter=t,this.movePositions=i(e,t.character.moveRadius,this.gamePlay.boardSize),this.attackPositions=i(e,t.character.attackRadius,this.gamePlay.boardSize)}moveCharacter(e){this.selectedCharacter.position=e,this.selectedCharacter=null,this.gamePlay.redrawPositions(this.gameState.positionedCharacters)}attackCharacter(e,t,a){const s=Math.round(Math.max(this.selectedCharacter.character.attack-t.character.defence,.1*this.selectedCharacter.character.attack));this.boardUnlocked=!1,this.gamePlay.showDamage(e,s).then(()=>{t.character.health-=s,this.gameState.positionedCharacters=this.gameState.positionedCharacters.filter(e=>e.character.health>0),this.selectedCharacter=null,this.gamePlay.redrawPositions(this.gameState.positionedCharacters),this.boardUnlocked=!0,a()})}isInnerCharacter(e){return-1!==this.gamePlay.cells[e].innerHTML.indexOf("character")}isInnerUsersCharacter(e){return e.player===this.gameState.user.player}isUsersActivePlayer(){return this.gameState.activePlayer===this.gameState.user.player}canMove(e){return-1!==this.movePositions.indexOf(e)}canAttack(e){return-1!==this.attackPositions.indexOf(e)}activateEngine(){this.gameState.activePlayer=this.gameState.engine.player;const e=r(this.gameState.positionedCharacters.filter(e=>e.player===this.gameState.engine.player));this.selectCharacter(e.position,e);const t=this.getUsersCharacterToAttack();if(!t){const e=this.getPositionToMoveEngine();return this.moveCharacter(e),void(this.gameState.activePlayer=this.gameState.user.player)}this.attackCharacter(t.position,t,()=>{this.hasRoundWinner()?this.roundUp():this.gameState.activePlayer=this.gameState.user.player})}getUsersCharacterToAttack(){return this.gameState.positionedCharacters.filter(e=>e.player===this.gameState.user.player).find(e=>-1!==this.attackPositions.indexOf(e.position))}getPositionToMoveEngine(){return r(this.movePositions.filter(e=>!this.isInnerCharacter(e)))}roundUp(){const e=this.hasRoundWinner();if(e.calcPoints(),this.gameState.round+=1,this.gameState.round>4){let e=this.gameState.user;return this.gameState.user.points<this.gameState.engine.points&&(e=this.gameState.engine),this.gameState.statistics.push({player:e.player,points:e.points}),n.showMessage(`${b.code104} ${e.player} (${e.points} points)`),this.gamePlay.drawUi(this.gameState.theme),this.boardUnlocked=!1,void console.log(this.gameState.statistics)}n.showMessage(`${b.code105} ${e.player} (${e.points} points)`),this.newRoundInit()}hasRoundWinner(){return 0===this.gameState.user.livingCharactersCount?this.gameState.engine:0===this.gameState.engine.livingCharactersCount?this.gameState.user:null}usersTeamUpdate(){if(1===this.gameState.round)return void(this.gameState.user.characters=[new d(1),new g(1)]);if(this.gameState.user.characters.forEach(e=>{e.levelUp(),e.restoreHealth()}),2===this.gameState.round){const e=w(this.gameState.user.allowedTypes,1).next().value;return void this.gameState.user.addCharacter(e)}const e=this.gameState.round-1,t=P(this.gameState.user.allowedTypes,e,2);this.gameState.user.addCharacters(t)}enginesTeamUpdate(){const e=this.gameState.round,t=this.gameState.user.livingCharactersCount,a=P(this.gameState.engine.allowedTypes,e,t);this.gameState.engine.characters=a}newRoundInit(){this.gameState.theme=h[`round${this.gameState.round}`],this.gamePlay.drawUi(this.gameState.theme),this.usersTeamUpdate(),this.enginesTeamUpdate(),this.gameState.positionedCharacters=function(e,t,a){const s=L(a,"left",e.charactersCount),i=e.characters.map((t,a)=>new S(t,s[a],e.player)),r=L(a,"right",t.charactersCount),n=t.characters.map((e,a)=>new S(e,r[a],t.player));return i.concat(n)}(this.gameState.user,this.gameState.engine,this.gamePlay.boardSize),this.gamePlay.redrawPositions(this.gameState.positionedCharacters),this.gameState.activePlayer=this.gameState.user.player,this.selectedCharacter=null}}(E,new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage)).init()}]);
